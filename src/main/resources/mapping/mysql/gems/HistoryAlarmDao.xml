<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zeei.gems.dao.HistoryAlarmDao">

	<select id="historyAlarmList" parameterType="Map" resultType="com.zeei.gems.vo.AlarmVO" >
		SELECT c.ALMTYPENAME,s.POINTNAME,c.DESCRIPTION,a.POLLUTECODE,s.POLLUTENAME,FORMAT(a.ALARMVALUE,s.NUMPRECISION) ALARMVALUE,SUBSTR(a.STARTTIME,1,19) STARTTIME, SUBSTR(a.ENDTIME,1,19) ENDTIME,c.ALARTYPELEVEL,e.CATEGORYNAME AS alarTypeLevelName 
		FROM T_BAS_ALMINFO a 
		LEFT JOIN T_BAS_ALM_DEF b ON a.ALARMCODE = b.ALARMCODE
		INNER JOIN V_ENV_STATIONPOLLINFO s ON s.POINTCODE=a.POINTCODE AND s.POLLUTECODE=a.POLLUTECODE
		LEFT JOIN T_BAS_ALM_TYPE c ON c.ALMTYPEID = b.ALMTYPEID
		LEFT JOIN T_DIC_GENERALCATEGORY e ON e.GENERALCODE = c.ALARTYPELEVEL
		WHERE a.ALARMSTATUS = 4
		<if test="vo.startTime != null and vo.startTime !='' ">
			AND a.STARTTIME &gt;= #{vo.startTime}
		</if>
		<if test="vo.endTime != null and vo.endTime !='' ">
			and a.STARTTIME &lt;= #{vo.endTime}
		</if>
		<if test="list != null">
			AND a.POINTCODE IN
			<foreach item="pointCode" index="index" collection="list" open="(" separator="," close=")">
				#{pointCode}
			</foreach>
		</if>
		<if test="vo.almTypeId != null and vo.almTypeId !='' ">
			AND c.ALMTYPEID = #{vo.almTypeId}
		</if>
		<if test="vo.alarTypeLevel != null and vo.alarTypeLevel !='' ">
			AND c.ALARTYPELEVEL  = #{vo.alarTypeLevel}
		</if>
		ORDER BY a.POINTCODE,b.ALMTYPEID,a.STARTTIME

	</select>

	<select id="historyAlarmCount" parameterType="Map" resultType="com.zeei.gems.vo.AlarmVO">
		SELECT a.STARTTIME
		FROM T_BAS_ALMINFO a 
		LEFT JOIN T_BAS_ALM_DEF b ON a.ALARMCODE = b.ALARMCODE
		LEFT JOIN V_BAS_POINTSITE_INFO d ON d.POINTCODE = a.POINTCODE
		LEFT JOIN T_BAS_ALM_TYPE c ON c.ALMTYPEID = b.ALMTYPEID
		LEFT JOIN T_DIC_GENERALCATEGORY e ON e.GENERALCODE = c.ALARTYPELEVEL
		WHERE a.ALARMSTATUS = 4
		AND a.STARTTIME &gt;= #{vo.startTime} 
		and a.STARTTIME &lt;= #{vo.endTime}
		<if test="list != null">
			AND a.POINTCODE IN
			<foreach item="pointCode" index="index" collection="list" open="(" separator="," close=")">
				#{pointCode}
			</foreach>
		</if>
		<if test="vo.almTypeId != null and vo.almTypeId !='' ">
			AND c.ALMTYPEID = #{vo.almTypeId}
		</if>
		<if test="vo.alarTypeLevel != null and vo.alarTypeLevel !='' ">
			AND c.ALARTYPELEVEL  = #{vo.alarTypeLevel}
		</if>
		ORDER BY a.STARTTIME

	</select>

	<select id="getAlarmType" resultType="Map">
		SELECT distinct a.ALMTYPEID AS id, a.ALMTYPENAME AS text
		FROM T_BAS_ALM_TYPE a 
		
	</select>

	<select id="getAlarmLevel" resultType="Map">
		SELECT a.GENERALCODE AS id, a.CATEGORYNAME AS text
		FROM T_DIC_GENERALCATEGORY a 
		where a.CATEGORYCLASS = "alarmLevel"
	</select>
</mapper>